package tcpserver

import "context"

// ConnectionHandlers содержит набор callback-функций для обработки событий соединения.
// Параметр типа T должен соответствовать типу, используемому в ProtocolParser.
//
// Все обработчики являются опциональными (могут быть nil).
// Если обработчик nil, соответствующее событие игнорируется.
//
// Обработчики могут быть заменены во время работы соединения с помощью
// метода Connection.SetHandlers(), например, после успешной аутентификации.
type ConnectionHandlers[T any] struct {
	// OnRead вызывается при получении нового пакета данных от клиента.
	// Вызывается для каждого успешно прочитанного пакета.
	//
	// Параметры:
	//   - ctx: контекст подключения, позволяющий отменить операцию при закрытии соединения
	//   - conn: соединение, от которого получены данные
	//   - packet: прочитанный пакет данных
	//
	// Примечание: обработчик вызывается синхронно внутри горутины чтения (readLoop).
	// Контекст автоматически отменяется при закрытии соединения.
	OnRead func(ctx context.Context, conn *Connection[T], packet T)

	// OnError вызывается при возникновении ошибки во время чтения или записи.
	// После вызова OnError соединение автоматически закрывается сервером.
	//
	// Параметры:
	//   - conn: соединение, в котором произошла ошибка
	//   - err: описание ошибки
	//
	// Примечание: OnError вызывается для ошибок ввода-вывода,
	// но не для ошибок в пользовательском коде обработчиков.
	OnError func(conn *Connection[T], err error)

	// OnStop вызывается при graceful shutdown сервера с таймаутом.
	// Этот обработчик должен выполнить финальные действия и завершить работу.
	//
	// Параметры:
	//   - conn: соединение, которое должно быть остановлено
	//
	// Примечание: OnStop вызывается только если Server.Stop() был вызван
	// с timeout > 0. После OnStop у соединения есть время до истечения
	// таймаута, чтобы корректно завершить работу. Если таймаут истек,
	// соединение будет закрыто принудительно.
	OnStop func(conn *Connection[T])

	// OnClosed вызывается после закрытия соединения.
	// Это последний обработчик, который будет вызван для данного соединения.
	//
	// Параметры:
	//   - conn: закрытое соединение
	//
	// Примечание: используйте OnClosed для освобождения ресурсов,
	// связанных с соединением (например, удаление из пользовательских карт,
	// закрытие файлов и т.д.). После вызова OnClosed объект Connection
	// больше не должен использоваться.
	OnClosed func(conn *Connection[T])
}
