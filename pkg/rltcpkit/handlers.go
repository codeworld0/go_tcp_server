package rltcpkit

import "context"

// ConnectionHandlers содержит набор callback-функций для обработки событий соединения.
// Параметр типа T должен соответствовать типу, используемому в ProtocolParser.
//
// Все обработчики являются опциональными (могут быть nil).
// Если обработчик nil, соответствующее событие игнорируется.
//
// Обработчики могут быть заменены во время работы соединения с помощью
// метода Connection.SetHandlers(), например, после успешной аутентификации.
type ConnectionHandlers[T any] struct {
	// OnConnected вызывается при запуске eventLoop, сразу после установки соединения.
	// Это первый обработчик, который вызывается для нового соединения.
	//
	// Параметры:
	//   - ctx: контекст подключения, позволяющий отменить операцию при закрытии соединения
	//   - conn: новое соединение
	//
	// Примечание: обработчик вызывается синхронно в начале eventLoop перед
	// началом обработки входящих сообщений. Используйте OnConnected для инициализации
	// ресурсов, связанных с соединением, или для отправки приветственных сообщений.
	OnConnected func(ctx context.Context, conn *Connection[T])

	// OnRead вызывается при получении нового пакета данных от клиента.
	// Вызывается для каждого успешно прочитанного пакета.
	//
	// Параметры:
	//   - ctx: контекст подключения, позволяющий отменить операцию при закрытии соединения
	//   - conn: соединение, от которого получены данные
	//   - packet: прочитанный пакет данных
	//
	// Примечание: обработчик вызывается синхронно внутри горутины чтения (readLoop).
	// Контекст автоматически отменяется при закрытии соединения.
	OnRead func(ctx context.Context, conn *Connection[T], packet T)

	// OnError вызывается при возникновении ошибки во время чтения или записи.
	// После вызова OnError соединение автоматически закрывается сервером.
	//
	// Параметры:
	//   - conn: соединение, в котором произошла ошибка
	//   - err: описание ошибки
	//
	// Примечание: OnError вызывается для ошибок ввода-вывода,
	// но не для ошибок в пользовательском коде обработчиков.
	OnError func(conn *Connection[T], err error)

	// OnStop вызывается при graceful shutdown сервера с таймаутом.
	// Этот обработчик должен выполнить финальные действия перед закрытием соединения.
	//
	// Параметры:
	//   - conn: соединение, которое должно быть остановлено
	//
	// Примечание: OnStop вызывается только если Server.Stop() был вызван
	// с timeout > 0. Если OnStop не установлен (nil), соединение будет
	// автоматически закрыто мягким способом (с завершением отправки буферизованных данных).
	// Если OnStop установлен, он должен выполнить необходимые действия и при необходимости
	// вызвать conn.Close(). После истечения таймаута все оставшиеся соединения будут
	// закрыты принудительно.
	OnStop func(conn *Connection[T])

	// OnClosed вызывается после закрытия соединения.
	// Это последний обработчик, который будет вызван для данного соединения.
	//
	// Параметры:
	//   - conn: закрытое соединение
	//
	// Примечание: используйте OnClosed для освобождения ресурсов,
	// связанных с соединением (например, удаление из пользовательских карт,
	// закрытие файлов и т.д.). После вызова OnClosed объект Connection
	// больше не должен использоваться.
	OnClosed func(conn *Connection[T])
}
