package rltcpkit

import (
	"context"
)

// ClientHandlers содержит набор callback-функций для обработки событий TCP клиента.
// Параметр типа T должен соответствовать типу, используемому в ProtocolParser.
//
// Все обработчики являются опциональными (могут быть nil).
// Если обработчик nil, соответствующее событие игнорируется.
type ClientHandlers[T any] struct {
	// OnConnected вызывается после успешного подключения к серверу.
	// Вызывается как при первичном подключении, так и при успешном переподключении.
	//
	// Параметры:
	//   - conn: установленное соединение с сервером
	//
	// Примечание: этот обработчик вызывается синхронно перед началом
	// обработки входящих данных. Можно использовать для инициализации
	// сессии, отправки приветственных сообщений и т.д.
	OnConnected func(conn *Connection[T])

	// OnDisconnected вызывается при разрыве соединения с сервером.
	// Вызывается как при ошибке соединения, так и при намеренном отключении.
	//
	// Параметры:
	//   - conn: закрытое соединение
	//   - err: причина разрыва соединения (может быть nil при явном Disconnect)
	//
	// Примечание: после вызова OnDisconnected, если включено автоматическое
	// переподключение (ReconnectEnabled = true), клиент попытается
	// восстановить соединение согласно настройкам в ClientConfig.
	OnDisconnected func(conn *Connection[T], err error)

	// OnRead вызывается при получении нового пакета данных от сервера.
	// Вызывается для каждого успешно прочитанного пакета.
	//
	// Параметры:
	//   - ctx: контекст подключения, позволяющий отменить операцию при закрытии соединения
	//   - conn: соединение, от которого получены данные
	//   - packet: прочитанный пакет данных
	//
	// Примечание: обработчик вызывается синхронно внутри горутины чтения.
	// Контекст автоматически отменяется при закрытии соединения.
	OnRead func(ctx context.Context, conn *Connection[T], packet T)

	// OnError вызывается при возникновении ошибки во время работы с соединением.
	// После вызова OnError соединение автоматически закрывается клиентом,
	// затем вызывается OnDisconnected.
	//
	// Параметры:
	//   - conn: соединение, в котором произошла ошибка
	//   - err: описание ошибки
	//
	// Примечание: OnError вызывается для ошибок ввода-вывода,
	// но не для ошибок в пользовательском коде обработчиков.
	// Если включено автоматическое переподключение, после OnError и OnDisconnected
	// будет вызван OnReconnecting.
	OnError func(conn *Connection[T], err error)

	// OnStop вызывается при graceful shutdown клиента (Client.Stop()).
	// Этот обработчик должен выполнить финальные действия перед закрытием соединения.
	//
	// Параметры:
	//   - conn: соединение, которое будет остановлено
	//
	// Примечание: OnStop вызывается только если Client.SetGracefulTimeout() был вызван
	// с timeout > 0 перед вызовом Stop(). После OnStop у соединения есть время до истечения
	// graceful timeout, чтобы корректно завершить работу (например, отправить финальные сообщения).
	// Если таймаут истек, соединение будет закрыто принудительно.
	// После OnStop всегда вызывается OnDisconnected.
	OnStop func(conn *Connection[T])

	// OnReconnecting вызывается непосредственно перед началом каждой попытки переподключения.
	// Вызывается только если ReconnectEnabled = true в ClientConfig.
	//
	// Параметры:
	//   - attempt: номер текущей попытки переподключения (начиная с 1)
	//
	// Примечание: обработчик вызывается после ожидания задержки reconnect,
	// непосредственно перед вызовом connect().
	// Это позволяет логгировать начало реальной попытки переподключения.
	// Задержка между попытками увеличивается экспоненциально согласно формуле:
	// min(ReconnectBaseDelay * 2^(attempt-1), ReconnectMaxDelay)
	OnReconnecting func(attempt int)
}
